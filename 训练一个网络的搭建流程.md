# 训练一个网络的搭建流程

数据加载模块 → 模型搭建模块 → 损失函数模块 → 训练循环模块 → 评估/保存模块

它们的依赖关系是：

**数据定义 → 决定模型输入形状 → 决定损失计算方式 → 决定训练流程。**

---

#### 推荐搭建顺序

| 步骤 | 模块                                    | 目标                                     | 是否必须   |
| ---- | --------------------------------------- | ---------------------------------------- | ---------- |
| ①    | **数据加载模块 (Dataset + Dataloader)** | 定义输入输出形状、批量读取、预处理、增强 | ✅ 必须先做 |
| ②    | **模型结构 (Model)**                    | 定义 forward 计算图                      | ✅ 第二步   |
| ③    | **损失函数 (Loss)**                     | 定义目标函数（L1、SSIM、感知损失等）     | ✅ 必须     |
| ④    | **优化器 (Optimizer + Scheduler)**      | 定义参数更新规则                         | ✅ 必须     |
| ⑤    | **训练循环 (train loop)**               | 前向 → 反向 → 更新                       | ✅ 必须     |
| ⑥    | **验证与可视化 (validation, log)**      | 查看模型效果                             | ⚙️ 推荐     |
| ⑦    | **推理模块 (Inference)**                | 用训练好的模型处理新图像                 | ⚙️ 推荐     |
| ⑧    | **配置与日志 (config, TensorBoard)**    | 组织项目结构、便于复现                   | 可选但重要 |

---

#### 1️⃣ 数据加载模块

为什么先做它？
 因为你必须明确：

- 模型输入是什么维度？
- 输出是什么？
- 一次训练用多少图像？
- 图像是否成对（noisy, clean）？

#### 2️⃣ 模型模块（**第二步**）

有了输入形状后，你可以自由定义网络结构（如 UNet, Restormer, etc）

#### 3️⃣ 损失函数模块（**第三步**）

定义你希望网络学习的目标。
 去噪任务常用：

- `nn.L1Loss()` 或 `nn.MSELoss()`
- 可加结构感知：`SSIMLoss`, `PerceptualLoss`

```python
criterion = nn.L1Loss()
```

#### 4️⃣ 优化器模块（**第四步**）

定义网络如何更新参数：

```python
optimizer = torch.optim.Adam(model.parameters(), lr=1e-4)
scheduler = torch.optim.lr_scheduler.StepLR(optimizer, step_size=20, gamma=0.5)
```

#### 5️⃣ 训练循环模块（**第五步**）

把上面所有组件串起来。

```python
for epoch in range(num_epochs):
    model.train()
    for noisy, clean in dataloader:
        noisy, clean = noisy.to(device), clean.to(device)
        optimizer.zero_grad()
        output = model(noisy)
        loss = criterion(output, clean)
        loss.backward()
        optimizer.step()
    scheduler.step()
```

#### 6️⃣ 验证与可视化模块

用于在训练中监控效果：

```python
import torchvision.utils as vutils

with torch.no_grad():
    model.eval()
    pred = model(val_noisy)
    vutils.save_image(torch.cat([val_noisy, pred, val_clean], dim=0), 'epoch_result.png')
```

#### 7️⃣ 推理模块（可最后做）

独立一个 `inference.py` 文件，实现大图滑动窗口推理（上一节讲过）。